<style>
    @import url("https://cdn.jsdelivr.net/gh/tonsky/FiraCode@1.207/distr/fira_code.css");
    @import url("https://dev-cats.github.io/code-snippets/JetBrainsMono.css");

    * {
        color: #444;
        scroll-behavior: smooth;
        scroll-padding-top: 5.5em;
        margin-top: 10px;
        animation: fade-in 0.2s ease-in-out;
    }
    
    body {
        background-color: white;
    }

    @keyframes fade-in {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }

    code, .tooltip, .usages-list-container {
        font-family: 'JetBrains Mono', 'Fira Code';
        font-size: 105%;
    }

    /* todo: span -> div, remove whitespacing at the end */
    div {
    }

    .doc {
        /* background-color: #6a8e231e !important; */
        color: rgba(90, 30, 64, 0.561);
    }

    .block {
        background-color: rgba(0, 0, 0, 0.05);
        cursor: pointer;
        visibility: visible;
    }

    .collapsed {
        /* display: none; */
    }

    .declaration-highlighted {
        background-color: #5e9efc !important;
        color: white !important;
    }

    .variable-usage {
        color: #5e9efc;
    }

    .function-usage {
        color: #2d68c1;
    }

    /* todo add unused code highlighting */
    /* todo add comment highlighting */

    .main {
        color: #fc5e5e;
        font-weight: bold;
        background-color: transparent;
    }

    .quote {
        color: #fc5e5e;
        background-color: transparent;
    }

    .data-type {
        color: #c25efc;
        background-color: transparent;
    }

    .literal {
        color: #000;
        background-color: transparent;
    }

    .keyword {
        color: #ff7c2c;
        background-color: transparent;
    }

    .comment {
        color: #6b8e23;
        background-color: transparent;
    }

    .tooltip {
        position: absolute;
        background-color: #44444480;
        backdrop-filter: blur(5px);
        color: white;
        padding: 0.4em;
        border-radius: 0.5em;
        z-index: 100;
        font-size: smaller;
        visibility: hidden;
    }

    .usages-list-container {
        position: absolute;
        background-color: #63307b80;
        backdrop-filter: blur(5px);
        color: white;
        padding: 0.4em;
        border-radius: 0.5em;
        z-index: 100;
        font-size: smaller;
        visibility: hidden;
    }

    /* .usages-list-container > * {
        color: white !important;
    } */

    .var-pointer {
        cursor: pointer;
        color: white;
    }

    .search-match {
        background-color: #fca05e;
        color: white;
    }

    #code-section {
        display: block;
    }

    #original-code-section {
        display: none; 
    }
</style>

<script>

    /////////////////////////
    // Search

    window.searchMode = false;

    function setSearchMode(val) {
        if (val === true) {
            window.searchMode = true;
            // #code-section should be invisible and #original-code-section should be visible
            document.getElementById("code-section").style.display = "none";
            document.getElementById("original-code-section").style.display = "block";
        } else {
            window.searchMode = false;
            // #code-section should be visible and #original-code-section should be invisible
            document.getElementById("code-section").style.display = "block";
            document.getElementById("original-code-section").style.display = "none";
            document.getElementById("original-code-section").innerHTML = originalCodeSnapshot; // reset to original
        }
    }

    let originalCodeSnapshot = "";

    function handleSearchResult(searchQuery) {
        const originalCode = document.getElementById("original-code-section").innerText;

        if (searchQuery) {
            setSearchMode(true);
            setTimeout(() => { setSearchMode(false); }, 5000);

            console.log("handling search result...", originalCode);
            const searchRegex = new RegExp(searchQuery, 'g');
            const matches = originalCode.match(searchRegex);
            const matchPositions = [...originalCode.matchAll(searchRegex)].map(m => m.index);

            let codeSnapshot = originalCode;

            for (let m of matchPositions.reverse()) {
                console.log("match", m);
                // добавить на месте матча теги в code
                codeSnapshot =  codeSnapshot.slice(0, m) +
                        '<span class="search-match">' +
                        codeSnapshot.slice(m, m + searchQuery.length) +
                        '</span>' + codeSnapshot.slice(m + searchQuery.length);
            }

            console.log("new code", codeSnapshot);
            document.getElementById("original-code-section").innerHTML = codeSnapshot;
        }
    }


    /////////////////////////
    // Inter-iframe communication

    let files = [];
    let thisFileUrl = "unknown";

    window.addEventListener('message', function(event) {
        if (event.data.type == "files") {
            files = event.data.files;
            console.log("Received files from parent!", files);
        }
        if (event.data.type == "this-file-url") {
            thisFileUrl = event.data.thisFileUrl;
            console.log("Received thisFileUrl from parent!", thisFileUrl);
        }
        if (event.data.type == "insta-jump") {
            console.log("Received insta-jump from parent!", event.data.hash);
            jumpTo(event.data.hash);
        }
        if (event.data.type == "search") {
            console.log("Received search from parent!", event.data.searchQuery);
            handleSearchResult(event.data.searchQuery);
        }
    });

    function requestSelectFile(fileId, hash) {
        window.parent.postMessage({ type: 'selectFile', fileId, hash }, '*');
    }

    // function sendMyCode() {
    //     const originalCode = document.getElementById("original-code-section").innerText;
    //     console.log("original code element: ", originalCode);
    //     window.parent.postMessage({ type: 'code', code: originalCode }, '*');
    // }


    /////////////////////////
    // Jumping to declarations

    function areUriEqual(uri1, uri2) { // todo not correct
        console.log("uri1 before: ", uri1);
        uri1 = uri1.substring(uri1.indexOf("test/") + 5);
        uri1 = uri1.substring(uri1.indexOf("/") + 1);
        console.log("uri1 after: ", uri1);
        console.log("uri2 before: ", uri2);
        uri2 = uri2.substring(uri2.indexOf("html/") + 5);
        uri2 = uri2.substring(0, uri2.indexOf(".codeview.html"));
        console.log("uri2 after: ", uri2);
        console.log("are uris equal: ", uri1 === uri2);
        return uri1 === uri2;
    }

    function jumpTo(hash, fileUri, fileUriCoded) {
        console.log(`Jumping to ${hash} in ${fileUri}`);
        console.log("compare: ", fileUri, thisFileUrl);
        if (fileUri === null) {
            console.log("encoded file uri: ", fileUriCoded);
            // from array of char codes to string
            fileUri = fileUriCoded.map(c => String.fromCharCode(c)).join("");
            console.log("decoded into: ", fileUri);
        }
        if (fileUri && !areUriEqual(fileUri, thisFileUrl)) {
            const fileId = files.findIndex(file => areUriEqual(fileUri, file.uri));
            requestSelectFile(fileId, hash);
        } else {
            window.location.hash = hash;
            console.log("jumping to: ", hash);
            document.getElementById(hash).classList.add("declaration-highlighted");
            setTimeout(() => {
                document.getElementById(hash).classList.remove("declaration-highlighted");
            }, 3000);
        }
    }


    /////////////////////////
    // Block Collapsing

    const collapseTimeout = 100;
    let canCollapse = true;
    let collapseBuffer = {};

    function _initiateCooldown(id) {
        canCollapse = false;
        setTimeout(() => {
            canCollapse = true;
        }, collapseTimeout);
    }

    function collapse(blockId) {
        // this is oncontextmenu, so we need to prevent default
        event.preventDefault();
        if (!canCollapse) return
        // toggling mechanism:
        if (document.getElementById(blockId).classList.contains("collapsed")) {
            // then we want to unravel
            console.log(`Unfolding ${blockId}!`)
            document.getElementById(blockId).classList.remove("collapsed")
            document.getElementById(blockId).innerHTML = collapseBuffer[blockId];
            _initiateCooldown(blockId)
        } else {
            // we want to collapse
            console.log(`Folding ${blockId}!`)
            document.getElementById(blockId).classList.add("collapsed")
            collapseBuffer[blockId] = document.getElementById(blockId).innerHTML;
            document.getElementById(blockId).innerHTML = "...";
            _initiateCooldown(blockId)
        }
    }


    /////////////////////////
    // Tooltip

    function showTooltip(event, elementId, tooltipText) {
        let tooltip = document.getElementById(`tooltip`);
        console.log(`Showing tooltip for ${elementId}! ${tooltipText}`);
        // visibility visible for tooltip
        if (tooltipText != "") tooltip.style.visibility = "visible";
        // move tooltip to mouse coords + scroll position
        tooltip.style.left = (event.clientX + window.pageXOffset + 16) + "px";
        tooltip.style.top = (event.clientY + window.pageYOffset + 8) + "px";
        // set tooltip text
        tooltip.innerHTML = tooltipText;
    }


    function hideTooltip() {
        let tooltip = document.getElementById(`tooltip`);
        tooltip.style.visibility = "hidden";
        console.log("Hiding tooltip!");
    }

    function createTooltip(){
        let tooltip = document.createElement("div");
        tooltip.innerHTML = "<tooltip>";
        tooltip.classList.add("tooltip");
        tooltip.id = `tooltip`;
        document.body.appendChild(tooltip);
    }


    /////////////////////////
    // Usages List

    function showUsagesList(usagesListHTML) {
        let usagesList = document.getElementById(`usages-list`);
        usagesList.style.visibility = "visible";
        // move usages-list to mouse coords + scroll position
        usagesList.style.left = "0px";
        usagesList.style.right = "0px";
        usagesList.style.top = (event.clientY + window.pageYOffset + 4) + "px";
        // set usages-list text
        usagesList.innerHTML = usagesListHTML;
    }

    function createUsagesListContainer() {
        let container = document.createElement("div");
        container.innerHTML = "<usages>";
        container.classList.add("usages-list-container");
        container.id = `usages-list`;
        document.body.appendChild(container);
        console.log("Created usages list container!");
    }

    function hideUsagesList() {
        let usagesList = document.getElementById(`usages-list`);
        usagesList.style.visibility = "hidden";
        console.log("Hiding usages list!");
    }


    /////////////////////////
    // Window Setup

    window.onload = () => {
        originalCodeSnapshot = document.getElementById("original-code-section").innerText;
        createTooltip();
        createUsagesListContainer();
    }
</script>

<!-- <pre><code>$codeString</code></pre> -->